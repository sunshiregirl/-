<!-- å£°æ˜æ–‡æ¡£ç±»å‹ -->
<!DOCTYPE html>
<!-- è¡¨ç¤ºæ•´ä¸ªç½‘é¡µçš„ä¸»è¦è¯­è¨€æ˜¯ç®€ä½“ä¸­æ–‡ -->
<html lang="zh-CN">
    <head>
        <!-- ä¸‰æœˆä¸ƒ -->
        <!-- æœ¬ç½‘é¡µä½¿ç”¨ UTF-8 å­—ç¬¦ç¼–ç æ¥å­˜å‚¨å’Œæ˜¾ç¤ºæ–‡å­— -->
        <meta charset="UTF-8">
        <!-- ç½‘é¡µå®½åº¦åº”ç­‰äºè®¾å¤‡å±å¹•å®½åº¦ï¼Œåˆå§‹ç¼©æ”¾æ¯”ä¾‹ä¸º 1 -->
        <meta name="viewport" content="width=device-width,initial-scale=1.0">
        <!-- ç½‘é¡µåå­— -->
        <title>å¡ç‰‡æ¶ˆæ¶ˆä¹</title>
        <!-- æ ·å¼ -->
        <style>
            /* æ¨èæ‰€æœ‰å…ƒç´ ç»Ÿä¸€ç”¨ border-box */
            *{
                padding: 0;
                margin: 0;
                box-sizing: border-box;       /* å®½é«˜åŒ…å«å†…å®¹ã€å†…è¾¹è·å’Œè¾¹æ¡† */
            }
            body {
                background: linear-gradient(135deg,#ffafbd 30%,#ffc3a0 70%);
                min-height: 100vh;
                display: flex;            /* æ‰€æœ‰ç›´æ¥å­å…ƒç´ ä¼šç«‹å³æˆä¸º â€œå¼¹æ€§é¡¹ç›®â€ï¼ŒæŒ‰å¼¹æ€§è§„åˆ™æ’åˆ— */
                flex-direction: column;   /* è®©å­å…ƒç´ çºµå‘æ’åˆ—ï¼ˆä»ä¸Šå¾€ä¸‹ï¼‰ */
                align-items: center;       
            }
            .game-header {
                /* æ¸¸æˆæ ‡é¢˜ */
                color: #fff;      
                /* æ°´å¹³ã€å‚ç›´ã€é˜´å½±åŠå¾„ã€é¢œè‰²ã€é€æ˜åº¦ */
                text-shadow: 2px 2px 4px rgba(0, 0, 0,.5);  
                margin: 20px 0;
                font-size: 2.5em;      /* å…¶çˆ¶å…ƒç´ å­—ä½“å¤§å°çš„ 2.5 å€ */
            }
            .remain-card {
                /* å‰©ä½™å¡ç‰‡å±•ç¤º */
                color: #fff;
                margin: 10px 0;
                font-size: 1.2em;
            }
            .circle-button {
                /* éŸ³é¢‘æŒ‰é’® */
                width: 60px;
                height: 60px;
                background: linear-gradient(135deg,#fc758c 30%,#f79156 70%);
                border-radius: 50%;               /*å°±æ˜¯ä¸€ä¸ªåœ† */
                display: flex;
                justify-content: center;    /* ä¸»è½´å±…ä¸­ï¼ˆæ°´å¹³ï¼‰ */
                align-items: center;        /* äº¤å‰è½´å±…ä¸­ï¼ˆå‚ç›´ï¼‰ */
                font-size: 30px;
                cursor: pointer;          /* å…‰æ ‡å˜æˆå°æ‰‹ */
                box-shadow: 0 4px 6px rgba(0, 0, 0,.3);
                position: relative;
                top: -700px;              /* è¡¨ç¤ºå…ƒç´ å‘ä¸Šç§»åŠ¨ 570 åƒç´ ï¼ˆè´Ÿå€¼æ˜¯å‘ä¸Šï¼‰ */
                right: -200px;            /* è¡¨ç¤ºå…ƒç´ å‘å³ç§»åŠ¨ 200 åƒç´ ï¼ˆè´Ÿå€¼æ˜¯å‘å³ï¼‰ */
                transition: transform 0.3s ease-in-out;        /* åŠ¨ç”»0.3såŒ€é€Ÿå¼€å§‹ */
            }
            .play-area {
                /* æ¸¸æˆæ“ä½œåŒºåŸŸ */
                width: 500px;
                height: 500px;
                background: rgba(255, 255, 255, .1);
                border-radius: 15px;
                box-shadow: 0 0 30px rgba(0, 0, 0, .2);
                overflow: hidden;      /* æ¸…é™¤æµ®åŠ¨ */
            }
            .cell {
                /* ç½‘æ ¼ */
                width: 25px;
                height: 25px;
                float: left;
                position: relative;
                border: 1px solid #eee ;
            }
            .select-all {
                /* é€‰æ‹©å¡ç‰‡å±•ç¤ºåŒºåŸŸ */
                width: 433px;
                height: 70px;
                background: rgba(255, 255, 255, .2);
                border-radius: 10px;
                margin: 30px 0;
                padding: 10px;
                display: flex;
                gap: 10px;            /* åœ¨å­å…ƒç´ ä¹‹é—´æ·»åŠ  10px çš„é—´è· */ 
                backdrop-filter: blur(5px);      /* èƒŒæ™¯æ¨¡ç³Š */
                border: 2px dashed rgba(255, 255, 255, .5);      /* è™šçº¿ */
            }
            .select-one {
                /* æ¯ä¸€ä¸ªé€‰æ‹©å¡ç‰‡å±•ç¤ºåŒºåŸŸ */
                width: 50px;
                height: 50px;
                background: rgba(255, 255, 255, .5);
                border-radius: 8px;
                position: relative;
                box-shadow: 0 3px 6px rgba(0, 0, 0, .2);
            }
            /* å®šä¹‰éŸ³é¢‘æŒ‰é’®æ—‹è½¬åŠ¨ç”» */
            .rotate {
                animation: spin 3s linear infinite;    /* åŠ¨ç”»å‘¨æœŸä¸º 3 ç§’ã€åŒ€é€Ÿæ—‹è½¬ã€æ— é™å¾ªç¯æ’­æ”¾ */
            }
            @keyframes spin{
                from{
                    transform: rotate(0deg);
                }
                to{
                    transform: rotate(360deg);
                }
            }
            .card {
                /* å¡ç‰‡ */
                width: 50px;
                height: 50px;
                background: linear-gradient(145deg,#fff,#f6f3f3);
                position: absolute;
                border-radius: 8px;
                box-shadow: 0 3px 6px rgba(0, 0, 0, .2);
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: 30px;
                color: #2c3e50;
            }
            .card:hover {
                transform: translateY(-6px);
                box-shadow: 0 5px 10px rgba(0, 0, 0,.3);
            }
            .card::before{
                content: '';
                position: absolute;
                top: 2px;
                right: 2px;
                bottom: 2px;
                left: 2px;
                border: 2px solid rgba(255, 255, 255, .3);
                border-radius: 6px;
            }
            .overlay {
                /* é®ç½© */
                width: 50px;
                height: 50px;
                background: rgba(255, 255, 255, .5);
                position: absolute;
                border-radius: 8px;
                backdrop-filter: blur(2px);
            }
        </style>
    </head>
    <body>
        <!-- æ ‡é¢˜ -->
        <h1 class="game-header">å¡ç‰‡æ¶ˆæ¶ˆä¹</h1>
        <!-- å‰©ä½™å¡ç‰‡æ•°é‡å±•ç¤º -->
        <div class="remain-card">å‰©ä½™å¡ç‰‡ï¼š<span id="remain-quantity">0</span></div>
        <!-- å¡ç‰‡å±•ç¤ºåŒºåŸŸ -->
        <div class="play-area"></div>
        <!-- å·²é€‰æ‹©å¡ç‰‡çš„å±•ç¤ºåŒºåŸŸï¼šæœ€å¤šé€‰æ‹©ä¸ƒä¸ª -->
        <div class="select-all">
            <div class="select-one"></div>
            <div class="select-one"></div>
            <div class="select-one"></div>
            <div class="select-one"></div>
            <div class="select-one"></div>
            <div class="select-one"></div>
            <div class="select-one"></div>
        </div>
        <!-- å¾ªç¯éŸ³ä¹æŒ‰é’® -->
        <div class="circle-button" id="play-pause-btn">ğŸµ</div>
        <!-- èƒŒæ™¯éŸ³ä¹ -->
        <audio id="background-music" loop>
            <source src="ä¸‰æœˆä¸ƒ.ogg" type="audio/ogg"/>
            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
        </audio>
    </body>
    <script>
        // è·å–éŸ³é¢‘å…ƒç´ å’ŒæŒ‰é’®
        const audio = document.getElementById('background-music')
        const button = document.getElementById('play-pause-btn')
        // åˆå§‹åŒ–éŸ³é¢‘çŠ¶æ€
        let isPlaying = false
        // ç»™æŒ‰é’®ç»‘å®šäº‹ä»¶
        button.addEventListener('click',function(){
            if(isPlaying){
                // æš‚åœæ’­æ”¾
                audio.pause()
                // æš‚åœæ—‹è½¬
                button.classList.remove('rotate')
            }else{
                // å¼€å§‹æ’­æ”¾
                audio.play().catch(err=>{
                    console.log('æ’­æ”¾å¤±è´¥',err)
                })
                // å¼€å§‹æ—‹è½¬
                button.classList.add('rotate')
            }
            // åˆ‡æ¢çŠ¶æ€
            isPlaying = !isPlaying
        })
        
        // åˆå§‹åŒ–æ¸¸æˆ
        const playArea = document.querySelector('.play-area')
        // ç½‘æ ¼æ˜ å°„
        const gridMap = {}
        // å¡ç‰‡å›¾æ¡ˆ
        const symbols = ['ğŸ','ğŸ','ğŸ±','ğŸ‡','ğŸ‚','ğŸ–','ğŸ','ğŸ‰','ğŸ…']

        // åˆ›å»ºç½‘æ ¼å¸ƒå±€
        for(let row = 0; row < 20; row++){
            for(let col = 0; col < 20; col++){
                const cell = document.createElement('div')
                cell.className = 'cell'
                playArea.appendChild(cell)
                gridMap[`${col}-${row}`] = cell
            }
        }

        //å¡ç‰‡ç®¡ç†
        let cardList = []
        // å·²é€‰æ‹©å¡ç‰‡
        let selectedCards = []
        // ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«7ä¸ªå¡æ§½å…ƒç´ 
        const selectAll = document.querySelectorAll('.select-one')
        // å‰©ä½™å¡ç‰‡æ•°é‡å…ƒç´ 
        const remainQuantity = document.getElementById('remain-quantity')

        //ç”Ÿæˆå…·ä½“å¡ç‰‡å…ƒç´ 
        function createCard(row,col,level){
            const card = document.createElement('div')
            card.className = 'card'
            card.style.zIndex = 10 - level
            // å­˜å‚¨å¡ç‰‡åæ ‡
            card.dataset.index = `${col}-${row}`
            return card
        }
       
        // æ£€æŸ¥å¡ç‰‡ä½ç½®æ˜¯å¦æœ‰æ•ˆ
        // layoutä¸ºå¡ç‰‡çš„äºŒç»´æ•°ç»„ 0ä¸ºç©º,1ä¸ºæœ‰
        function isValid(row,col,layout){
            // æ£€æŸ¥å·¦,å·¦ä¸Š,ä¸Š,å³ä¸Šå››ä¸ªæ–¹å‘
            return ![layout[row][col-1],
                    layout[row-1]?.[col-1],
                    layout[row-1]?.[col],
                    layout[row-1]?.[col+1]
            ].includes(1)
        }
    
        //ç”Ÿæˆå¡ç‰‡å¸ƒå±€
        function generateLayout(level){
            //åˆå§‹åŒ–layout
            const layout = Array.from({length:20},()=>Array(20).fill(0))
            //æ ¹æ®levelç¡®å®šç”ŸæˆèŒƒå›´
            for (let i = level; i < 19 - level; i++){
                for (let j = 1; j < 10; j++){
                    // 20%ç”Ÿæˆå¡ç‰‡ï¼Œå¹¶æ£€æŸ¥ä½ç½®æ˜¯å¦æœ‰æ•ˆ
                    if (Math.random() < 0.2 && isValid(i,j,layout)){
                        layout[i][j] = 1;
                        layout[i][18-j] = 1;
                    }
                }
            }

            //æ ¹æ®layoutåˆ›å»ºå¡ç‰‡å¹¶æ·»åŠ åˆ°DOM
            layout.forEach((row,i) => {
                row.forEach((val,j) => {
                    if (val === 1){
                        const card = createCard(i,j,level);
                        gridMap[`${j}-${i}`].appendChild(card);
                        cardList.push(card);
                    }
                })
            })
        }

        // åˆå§‹åŒ–å¡ç‰‡
        for (i = 7; i > 0; i--) generateLayout(i)

        //æ›´æ–°å¡ç‰‡å‰©ä½™æ•°é‡
        function updateQuantity(){
            remainQuantity.textContent = cardList.length
        }

        // ç§»é™¤å¤šä½™çš„å¡ç‰‡ï¼Œä¿è¯æ˜¯3çš„å€æ•°
        const extra = cardList.length % 3
        if (extra !== 0){
            const toRemove = cardList.splice(-extra,extra)
            toRemove.forEach(card => card.parentNode.removeChild(card))
        }
        updateQuantity()

        //åˆ†é…å›¾æ¡ˆ
        const patternList = []
        const totalGroups = Math.floor(cardList.length / 3)
        for (let i = 0; i < totalGroups; i++){
            patternList.push(...Array(3).fill(symbols[i % symbols.length]))
        }
        // patternList.sort(() => Math.random -0.5)
        shuffle(patternList)
        cardList.forEach((card,i)=>{
            card.textContent = patternList[i]
            card.dataset.type = patternList[i]
        })

        // æ´—ç‰Œç®—æ³•
        function shuffle(array){
            for (let i = array.length -1; i > 0; i--){
                const j = Math.floor(Math.random() * (i + 1));
                [array[i],array[j]] = [array[j],array[i]];
                return array
            }
        }

        //ç»™è¢«é®ä½çš„å¡ç‰‡å°è£…é®ç½©å±‚
        function renderOverlay(){
            document.querySelectorAll('.overlay').forEach(mask => mask.remove())
            cardList.forEach(card => {
                const rect = card.getBoundingClientRect()      // è·å–ç›¸å¯¹äºè§†å£çš„xyåæ ‡
                const points = [
                    // cardçš„å››ä¸ªè§’
                    [rect.left,rect.top],
                    [rect.left + 49,rect.top],
                    [rect.left,rect.top + 49],
                    [rect.left + 49,rect.top + 49]
                ]
                // è¯¥ç‚¹æ˜¯å¦è¢«è¦†ç›–
                const isCovered = points.some(([x,y]) => {
                    const el = document.elementFromPoint(x,y)
                    return el !== card && cardList.includes(el)
                })
                //æ·»åŠ é®ç½©å±‚
                if (isCovered){
                    const overlay = document.createElement('div')
                    overlay.className = 'overlay'
                    overlay.style.zIndex = card.style.zIndex
                    card.parentNode.appendChild(overlay)
                }
            })
        }
        renderOverlay()

        // æ¸¸æˆé€»è¾‘
        playArea.addEventListener('click', function(e){
            if(!e.target.classList.contains('card')) return;
            const card = e.target;
            card.parentNode.removeChild(card);
            cardList = cardList.filter(t => t !== card);            //è¿‡æ»¤ï¼Œæ»¡è¶³æ¡ä»¶åˆ™ä¿ç•™ä¸‹æ¥
            updateQuantity();          //æ›´æ–°å‰©ä½™æ•°é‡

            selectedCards.push(card);
            if (selectedCards.length > 7) endGame()
            checkMatches()
            renderOverlay();            // é‡æ–°æ¸²æŸ“é®ç½©å±‚
            updateSelectAll()
        })

        // æ›´æ–°é€‰æ‹©æ§½ä¸­çš„å¡ç‰‡æ˜¾ç¤º
        function updateSelectAll(){
            selectAll.forEach(selectOne => selectOne.innerHTML = '')
            selectedCards.forEach((card,i) => {
                const clone = card.cloneNode(true)
                clone.style.position = 'static'
                selectAll[i].appendChild(clone)
            })
        }

        //æ£€æŸ¥å¡ç‰‡æ§½é‡Œæ˜¯å¦æœ‰ä¸‰ä¸ªå¯ä»¥æ¶ˆé™¤
        function checkMatches(){
            const countMap = selectedCards.reduce((acc,card)=>{
                acc[card.dataset.type] = (acc[card.dataset.type] || 0) + 1
                return acc
            },{})
            Object.entries(countMap).forEach(([type,count])=>{
                if(count >= 3){
                    selectedCards = selectedCards.filter(card => card.dataset.type !== type)
                }
            }) 
        }

        // æ¸¸æˆå¤±è´¥å¤„ç†
        function endGame(){
            alert('æ¸¸æˆå¤±è´¥ï¼è¯·é‡æ–°å¼€å§‹ï¼')
            location.reload()
        }

        // å®šæ—¶æ£€æŸ¥æ¸¸æˆæ˜¯å¦é€šå…³
        setInterval(() => {
            if (cardList.length === 0 && selectedCards.length === 0){
                alert('æ­å–œé€šå…³ï¼')
                location.reload()
            }
        }, 1000);
    </script>
</html>